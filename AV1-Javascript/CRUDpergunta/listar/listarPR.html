<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Quiz</title>
  <link rel="stylesheet" href="/AV1-Javascript/style.css">

  <style>
      main table {
          width: 100%;  
          max-width: 100%;
          table-layout: fixed; 
          word-wrap: break-word;
      }
      #opcoes {
        display: flex;
        flex-direction: column;
        gap: 8px; 
        margin-bottom: 20px;
        width: fit-content;
      }

      #opcoes label {
        display: flex;
        align-items: center;
        gap: 10px; 
        cursor: pointer;
        width: fit-content;
      }

      #opcoes input[type="radio"] {
        cursor: pointer;
        width: fit-content;
      }
  </style>
</head>
<body>
    <nav>
        <a href="/AV1-Javascript/home.php">Home</a>
        <a href="/AV1-Javascript/CRUDpergunta/criar/criarMulti.html">Perguntas</a>
        <a href="/AV1-Javascript/CRUDusuario/listar.html">Usuários</a>
        <a href="/AV1-Javascript/logout.php" class="logout">Sair</a>
    </nav>
    <div class="sub-nav">
        <a href="/AV1-Javascript/CRUDpergunta/criar/criarMulti.html">Criar Múltipla Escolha</a><br>
        <a href="/AV1-Javascript/CRUDpergunta/criar/criarDisc.html">Criar Discursiva</a><br>
        <a href="/AV1-Javascript/CRUDpergunta/listar/listarPR.html?reset=1">Quiz Perguntas e Respostas</a><br>
        <a href="/AV1-Javascript/CRUDpergunta/listar/listarUmaPerg.html">Listar uma Pergunta</a><br>
        <a href="/AV1-Javascript/CRUDpergunta/listar/listarTodasP.html">Listar Todas/Alterar/Deletar</a><br>
    </div>
    
    <h2 id="titulo"></h2>
    <main class="main-align">

      <p id="pergunta"></p>

      <aside id="opcoes"></aside>

      <button id="enviar">Enviar</button>

    </main>

    <script>
      let perguntas = [];
      let indice = 0;
      let respostas = [];

      async function carregarPerguntas() {
        const resp = await fetch("listarPR.php");
        perguntas = await resp.json();
        mostrarPergunta();
      }

      function mostrarPergunta() {
        if (indice >= perguntas.length) return mostrarResultado();

        const p = perguntas[indice];
        const titulo = document.getElementById("titulo");
        const pergunta = document.getElementById("pergunta");
        const opcoes = document.getElementById("opcoes");
        
        titulo.textContent = `Pergunta ${indice + 1} de ${perguntas.length}`;
        pergunta.textContent = p[1];
        opcoes.innerHTML = "";

        const isDiscursiva = !p[2] && !p[3] && !p[4] && !p[5];

        if (!isDiscursiva) {
          ["A","B","C","D","E"].forEach((letra, i) => {
            if (p[i+2]) {
              const lbl = document.createElement("label");
              lbl.innerHTML = `<input type="radio" name="resposta" value="${letra}"><span> ${letra}) ${p[i+2]}</span><br>`;
              opcoes.appendChild(lbl);
            }
          });
        } else {
          const txt = document.createElement("textarea");
          txt.name = "resposta";
          txt.required = true;
          opcoes.appendChild(txt);
        }
      }

      document.getElementById("enviar").addEventListener("click", () => {
        const p = perguntas[indice];
        const isDiscursiva = !p[2] && !p[3] && !p[4] && !p[5];
        const certa = p[7]?.trim()?.toUpperCase() || "";
        let resposta = "";

        if (isDiscursiva) {
          resposta = document.querySelector("textarea")?.value.trim();
          respostas.push({ pergunta: p[1], resposta, certa, correto: null });
        } else {
          const sel = document.querySelector("input[name=resposta]:checked");
          if (!sel) return alert("Selecione uma opção!");
          resposta = sel.value;
          respostas.push({ pergunta: p[1], resposta, certa, correto: resposta === certa });
        }

        indice++;
        mostrarPergunta();
      });

      function mostrarResultado() {

        const main = document.querySelector("main");
        main.innerHTML = "<h2>Quiz finalizado!</h2>";

        let acertos = 0;
        respostas.forEach(r => {
          if (r.correto) acertos++;
        });

        let html = "<table border='1' cellpadding='5'><tr><th>Pergunta</th><th>Sua resposta</th><th>Certa</th><th>Status</th></tr>";
        respostas.forEach(r => {
          const status = r.correto === null ? "-" : (r.correto ? "✔️" : "❌");
          html += `<tr><td>${r.pergunta}</td><td>${r.resposta}</td><td>${r.certa}</td><td>${status}</td></tr>`;
        });
        html += "</table>";
        html += `<p>Você acertou ${acertos} de ${respostas.length}!</p>`;
        html += `<button onclick="location.reload()">Reiniciar</button>`;

        main.innerHTML += html;
      }

      carregarPerguntas();
    </script>
</body>
</html>
